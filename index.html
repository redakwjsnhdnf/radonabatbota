<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REDA | WASTELAND EXPLORER</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; touch-action: none; }
        #ui { position: absolute; top: 10px; left: 10px; color: #00ff00; text-shadow: 0 0 5px #00ff00; z-index: 100; pointer-events: none; }
        #controls-hint { position: absolute; bottom: 10px; width: 100%; text-align: center; color: rgba(0,255,0,0.5); font-size: 12px; }
        canvas { display: block; }
    </style>
</head>
<body>
    <div id="ui">
        <h2>WASTELAND EXPLORER</h2>
        <p>POS: X:<span id="pos-x">0</span> Y:<span id="pos-y">0</span> Z:<span id="pos-z">0</span></p>
    </div>
    <div id="controls-hint">PC: WASD to Move, Mouse to Look | Mobile: Touchpad to Move/Look (Experimental)</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer;
        let player, playerSpeed = 0.1;
        let keys = { w: false, a: false, s: false, d: false };
        let mouseX = 0, mouseY = 0, targetRotationX = 0, targetRotationY = 0;
        const worldSize = 100; // حجم العالم
        const objects = [];

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x222222); // سماء صحراوية
            scene.fog = new THREE.Fog(0x222222, 50, 200);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.8, 0); // ارتفاع الكاميرا (من منظور الشخص الأول)
            camera.rotation.order = 'YXZ'; // ترتيب دوران الكاميرا مهم لتجنب "Gimbal Lock"

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // الإضاءة (شمس الصحراء)
            const sunLight = new THREE.DirectionalLight(0xffddaa, 2);
            sunLight.position.set(50, 100, 50);
            sunLight.castShadow = true;
            scene.add(sunLight);
            scene.add(new THREE.AmbientLight(0x444444));

            // اللاعب (شخصية مكعبة بسيطة)
            const playerGeo = new THREE.BoxGeometry(1, 1.8, 1);
            const playerMat = new THREE.MeshPhongMaterial({ color: 0x00ff00 });
            player = new THREE.Mesh(playerGeo, playerMat);
            player.position.y = 0.9; // ليكون منتصباً على الأرض
            // player.visible = false; // يمكن إخفائه ليكون منظور الشخص الأول
            scene.add(player);

            // الأرضية (تضاريس صحراوية)
            const groundGeo = new THREE.PlaneGeometry(worldSize * 2, worldSize * 2, worldSize, worldSize);
            const groundMat = new THREE.MeshPhongMaterial({ color: 0x886633, side: THREE.DoubleSide });
            // تعديل ارتفاعات الأرضية بشكل عشوائي (تضاريس)
            const position = groundGeo.attributes.position;
            const vertex = new THREE.Vector3();
            for (let i = 0; i < position.count; i++) {
                vertex.fromBufferAttribute(position, i);
                vertex.z += Math.random() * 5 - 2.5; // إضافة ارتفاع عشوائي
                position.setZ(i, vertex.z);
            }
            groundGeo.computeVertexNormals();
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.01;
            scene.add(ground);

            // إضافة أشجار / صخور عشوائية
            const treeGeo = new THREE.CylinderGeometry(0.5, 1, 5, 8);
            const treeMat = new THREE.MeshPhongMaterial({ color: 0x663300 });
            for (let i = 0; i < 50; i++) {
                const tree = new THREE.Mesh(treeGeo, treeMat);
                tree.position.set(
                    Math.random() * worldSize - worldSize / 2,
                    2.5, // ارتفاع الشجرة
                    Math.random() * worldSize - worldSize / 2
                );
                scene.add(tree);
                objects.push(tree);
            }


            // أحداث التحكم (PC)
            window.addEventListener('keydown', onKeyDown);
            window.addEventListener('keyup', onKeyUp);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('click', () => renderer.domElement.requestPointerLock()); // قفل المؤشر

            // أحداث التحكم (Mobile - تجريبي)
            renderer.domElement.addEventListener('touchstart', onTouchStart);
            renderer.domElement.addEventListener('touchmove', onTouchMove);

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function onKeyDown(event) { if (event.key === 'w') keys.w = true; if (event.key === 's') keys.s = true; if (event.key === 'a') keys.a = true; if (event.key === 'd') keys.d = true; }
        function onKeyUp(event) { if (event.key === 'w') keys.w = false; if (event.key === 's') keys.s = false; if (event.key === 'a') keys.a = false; if (event.key === 'd') keys.d = false; }

        function onMouseMove(event) {
            if (document.pointerLockElement === renderer.domElement) {
                targetRotationX -= event.movementY * 0.002;
                targetRotationY -= event.movementX * 0.002;
                targetRotationX = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, targetRotationX)); // حد دوران الكاميرا
            }
        }

        // تحكم اللمس (تجريبي - يحتاج تحسين)
        let lastTouchX = 0, lastTouchY = 0;
        function onTouchStart(event) {
            lastTouchX = event.touches[0].clientX;
            lastTouchY = event.touches[0].clientY;
        }
        function onTouchMove(event) {
            const deltaX = event.touches[0].clientX - lastTouchX;
            const deltaY = event.touches[0].clientY - lastTouchY;
            
            targetRotationY -= deltaX * 0.005; // دوران أفقي
            targetRotationX -= deltaY * 0.005; // دوران عمودي
            targetRotationX = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, targetRotationX));
            
            lastTouchX = event.touches[0].clientX;
            lastTouchY = event.touches[0].clientY;

            // حركة اللاعب باللمس (تجريبي)
            if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > 5) { // حركة للأمام/الخلف
                if (deltaY < 0) keys.w = true; else keys.s = true;
                setTimeout(() => { keys.w = false; keys.s = false; }, 100); // للحظة فقط
            }
        }

        function animate() {
            requestAnimationFrame(animate);

            // تحديث دوران الكاميرا
            camera.rotation.y = targetRotationY;
            camera.rotation.x = targetRotationX;

            // حركة اللاعب (PC)
            const forward = new THREE.Vector3();
            camera.getWorldDirection(forward);
            forward.y = 0; forward.normalize(); // لعدم الطيران
            const right = new THREE.Vector3().crossVectors(camera.up, forward).normalize();

            if (keys.w) { camera.position.addScaledVector(forward, playerSpeed); }
            if (keys.s) { camera.position.addScaledVector(forward, -playerSpeed); }
            if (keys.a) { camera.position.addScaledVector(right, -playerSpeed); }
            if (keys.d) { camera.position.addScaledVector(right, playerSpeed); }

            // تحديث موقع اللاعب (لأغراض الـ UI)
            player.position.copy(camera.position);

            document.getElementById('pos-x').innerText = camera.position.x.toFixed(2);
            document.getElementById('pos-y').innerText = camera.position.y.toFixed(2);
            document.getElementById('pos-z').innerText = camera.position.z.toFixed(2);

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        init();
    </script>
</body>
</html>
