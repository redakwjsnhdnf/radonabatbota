<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REDA WORLD v2.0 | STABLE</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Segoe UI', sans-serif; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #dialog { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); width: 80%; background: rgba(0,0,0,0.8); color: #fff; padding: 20px; border-radius: 15px; border: 2px solid #fbff00; display: none; pointer-events: auto; text-align: center; }
        #instructions { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.7); padding: 10px; border-radius: 5px; font-size: 12px; }
        .btn-jump { position: absolute; bottom: 30px; right: 30px; width: 80px; height: 80px; background: orange; border-radius: 50%; border: 4px solid #fff; font-weight: bold; pointer-events: auto; cursor: pointer; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="instructions">PC: WASD + Mouse | Mobile: Touch to Jump</div>
        <div id="dialog">
            <b id="npc-name">العجوز الحكيم:</b><br>
            <span id="npc-text">أهلاً بك يا رضا! هذا العالم مليء بالأسرار.. هل أنت مستعد؟</span>
            <br><button onclick="closeDialog()" style="margin-top:10px; cursor:pointer;">موافق</button>
        </div>
        <button class="btn-jump" id="mobileJump">JUMP</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, player, npc, clock;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let vY = 0, canJump = false;
        const playerSpeed = 0.15;

        init();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 20, 100);
            clock = new THREE.Clock();

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // إضاءة احترافية
            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(50, 50, 50);
            sun.castShadow = true;
            sun.shadow.camera.left = -50; sun.shadow.camera.right = 50;
            sun.shadow.camera.top = 50; sun.shadow.camera.bottom = -50;
            scene.add(sun, new THREE.AmbientLight(0x999999));

            // الأرضية
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshPhongMaterial({color: 0x4CAF50}));
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // الشخصية الرئيسية (Player)
            player = new THREE.Group();
            const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1, 4, 8), new THREE.MeshPhongMaterial({color: 0x1e90ff}));
            body.position.y = 0.9; body.castShadow = true;
            player.add(body);
            scene.add(player);

            // شخصية NPC (العجوز الحكيم)
            npc = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshPhongMaterial({color: 0xff4500}));
            npc.position.set(5, 1, -5);
            npc.castShadow = true;
            scene.add(npc);

            // التحكم
            document.addEventListener('keydown', (e) => handleKeys(e.code, true));
            document.addEventListener('keyup', (e) => handleKeys(e.code, false));
            document.addEventListener('mousedown', () => document.body.requestPointerLock());
            document.addEventListener('mousemove', (e) => {
                if(document.pointerLockElement) player.rotation.y -= e.movementX * 0.003;
            });
            document.getElementById('mobileJump').addEventListener('touchstart', () => { if(canJump) vY = 0.2; });

            animate();
        }

        function handleKeys(code, val) {
            if(code === 'KeyW') moveForward = val;
            if(code === 'KeyS') moveBackward = val;
            if(code === 'KeyA') moveLeft = val;
            if(code === 'KeyD') moveRight = val;
            if(code === 'Space' && val && canJump) vY = 0.2;
        }

        function closeDialog() { document.getElementById('dialog').style.display = 'none'; }

        function animate() {
            requestAnimationFrame(animate);
            let delta = clock.getDelta();

            // منطق الحركة
            vY -= 0.01; // الجاذبية
            player.position.y += vY;

            if(player.position.y <= 0) {
                player.position.y = 0; vY = 0; canJump = true;
            } else { canJump = false; }

            if(moveForward) player.translateZ(-playerSpeed);
            if(moveBackward) player.translateZ(playerSpeed);
            if(moveLeft) player.translateX(-playerSpeed);
            if(moveRight) player.translateX(playerSpeed);

            // الكاميرا (Third Person Smooth)
            const offset = new THREE.Vector3(0, 3, 6).applyMatrix4(player.matrixWorld);
            camera.position.lerp(offset, 0.1);
            camera.lookAt(player.position.x, player.position.y + 1.5, player.position.z);

            // فحص القرب من NPC للحديث
            let dist = player.position.distanceTo(npc.position);
            if(dist < 3) document.getElementById('dialog').style.display = 'block';

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
